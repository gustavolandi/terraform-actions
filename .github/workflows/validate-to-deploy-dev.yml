name: Validate
on:
  workflow_call:
    inputs:
      TF_STATE_BUCKET_NAME:
        description: "bucket name terraform state"
        required: true
        type: string
      TF_STATE_KEY_PATH:
        description: "bucket name terraform state"
        required: true
        type: string
      TF_STATE_REGION:
        description: "aws region bucket for terraform state"
        required: false
        default: "sa-east-1"
        type: string
      PROJECT_VARIABLES_FILE:
          description: "file path for environment variables"
          required: false
          default: "infra/dev/parameters.tfvars"
          type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
          required: true

env:
  AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
  AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}

jobs:
  debug_inputs:
    name: Debug Inputs
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Debug
        run: |
          echo "TF_STATE_BUCKET_NAME=${{ inputs.TF_STATE_BUCKET_NAME }}"
          echo "TF_STATE_KEY_PATH=${{ inputs.TF_STATE_KEY_PATH }}"
          echo "TF_STATE_REGION=${{ inputs.TF_STATE_REGION }}"
          echo "PROJECT_VARIABLES_FILE=${{ inputs.PROJECT_VARIABLES_FILE }}"
  terraform_validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Terraform Plan
      run: |
        terraform init \
          -backend-config="bucket=${{vars.TF_STATE_BUCKET_NAME}}" \
          -backend-config="key=${{vars.TF_STATE_KEY_PATH}}/terraform.tfstate" \
          -backend-config="region=${{vars.TF_STATE_REGION}}"
        terraform validate
        terraform workspace select dev || terraform workspace new dev
        terraform plan -var-file="${{vars.PROJECT_VARIABLES_FILE}}"
  
  pull_request:
    name: Pull Request
    runs-on: ubuntu-latest
    needs:
      - terraform_validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Create Pull Request To develop
        continue-on-error: true
        run: gh pr create -B develop  -H ${{ github.head_ref || github.ref_name }} --title 'Merge ${{ github.head_ref || github.ref_name }} into develop' --body 'Created by Github action'
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  